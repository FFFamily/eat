<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tutu.user.mapper.AccountCustomerMapper">

    <!-- 根据账户ID查询客户列表（带账户名称） -->
    <select id="selectByAccountIdWithAccount" resultType="com.tutu.user.entity.AccountCustomer">
        SELECT 
            ac.*,
            a.nickname as accountName,
            ca.nickname as customerAccountName
        FROM account_customer ac
        LEFT JOIN account a ON ac.account_id = a.id
        LEFT JOIN account ca ON ac.customer_account_id = ca.id
        WHERE ac.account_id = #{accountId} AND ac.is_deleted = '0'
        ORDER BY ac.create_time DESC
    </select>

    <!-- 根据客户账户ID查询账户列表（带账户名称） -->
    <select id="selectByCustomerAccountIdWithAccount" resultType="com.tutu.user.entity.AccountCustomer">
        SELECT 
            ac.*,
            a.nickname as accountName,
            ca.nickname as customerAccountName
        FROM account_customer ac
        LEFT JOIN account a ON ac.account_id = a.id
        LEFT JOIN account ca ON ac.customer_account_id = ca.id
        WHERE ac.customer_account_id = #{customerAccountId} AND ac.is_deleted = '0'
        ORDER BY ac.create_time DESC
    </select>

    <!-- 根据ID查询详情（带账户名称） -->
    <select id="selectByIdWithAccount" resultType="com.tutu.user.entity.AccountCustomer">
        SELECT 
            ac.*,
            a.nickname as accountName,
            ca.nickname as customerAccountName
        FROM account_customer ac
        LEFT JOIN account a ON ac.account_id = a.id
        LEFT JOIN account ca ON ac.customer_account_id = ca.id
        WHERE ac.id = #{id} AND ac.is_deleted = '0'
    </select>

    <!-- 分页查询（带账户名称） -->
    <select id="selectPageWithAccount" resultType="com.tutu.user.entity.AccountCustomer">
        SELECT 
            ac.*,
            a.nickname as accountName,
            ca.nickname as customerAccountName
        FROM account_customer ac
        LEFT JOIN account a ON ac.account_id = a.id
        LEFT JOIN account ca ON ac.customer_account_id = ca.id
        WHERE ac.is_deleted = '0'
        <if test="query != null">
            <if test="query.accountId != null and query.accountId != ''">
                AND ac.account_id = #{query.accountId}
            </if>
            <if test="query.customerAccountId != null and query.customerAccountId != ''">
                AND ac.customer_account_id = #{query.customerAccountId}
            </if>
        </if>
        ORDER BY ac.create_time DESC
    </select>

    <!-- 检查是否存在未删除的重复记录（用于校验） -->
    <select id="countActiveDuplicate" resultType="long">
        SELECT COUNT(1)
        FROM account_customer
        WHERE account_id = #{accountId}
          AND customer_account_id = #{customerAccountId}
          AND is_deleted = '0'
        <if test="excludeId != null and excludeId != ''">
          AND id != #{excludeId}
        </if>
    </select>

</mapper>

